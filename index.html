<div id="game" class="justify-center items-center w-500 h-500">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
    integrity="sha512-wnea99uKIC3TJF7v4eKk4Y+lMz2Mklv18+r4na2Gn1abDRPPOeef95xTzdwGD9e6zXJBteMIhZ1+68QC5byJZw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <style>
    body {
      margin: 0;
      background-color: black;
    }
  </style>
  <div class="absolute text-white text-sm ml-2 mt-1 select-none">
    <span>Time: </span><span id="timeEl">0</span>
  </div>
  <br />
  <div class="absolute text-white text-sm ml-2 mt-1 select-none">
    <span>Score: </span><span id="scoreEl">0</span>
  </div>

  <div
    class="absolute inset-0 flex items-center justify-center"
    id="modalEl"
    style="display: flex"
  >
    <div
      class="bg-white max-w-md w-full p-6 text-center"
      style="transform: translate(0px, 0px); opacity: 1"
    >
      <h1 id="bigScoreEl" class="text-4xl font-bold leading-none">0</h1>
      <p class="text-sm text-gray-700 mb-4">Points</p>
      <div>
        <button
          class="bg-blue-500 hover:bg-blue-600 text-white w-full py-3 rounded-full text-sm"
          id="startGameElBtn"
        >
          Start Game
        </button>
      </div>

      <div id="submitGameEl">
        <button
          class="bg-green-500 hover:bg-green-600 text-white w-full py-3 rounded-full text-sm"
          id="submitGameElBtn"
        >
          Run Your Codes
        </button>
        <div class="mb-3 xl:w-96" id="submitAnswerEl" style="display: none">
          <textarea
            class="form-control block w-full px-3 py-1.5 text-base font-normal text-gray-700 bg-white bg-clip-padding border border-solid border-gray-300 rounded transition ease-in-out m-0 focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none"
            id="submitFormEl"
            rows="3"
            placeholder="Submittion"
          ></textarea>
        </div>
        <button
          class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
          id="submitBtnEl"
          style="display: none"
        >
          Run!
        </button>
      </div>

      <div id="answerGameEl">
        <button
          class="bg-yellow-500 hover:bg-yellow-600 text-white w-full py-3 rounded-full text-sm"
          id="exportGameElBtn"
        >
          Export Your answer
        </button>
        <div class="mb-3 xl:w-96" id="exportAnswerEl" style="display: none">
          <textarea
            class="form-control block w-full px-3 py-1.5 text-base font-normal text-gray-700 bg-white bg-clip-padding border border-solid border-gray-300 rounded transition ease-in-out m-0 focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none"
            id="answerFromEl"
            rows="3"
            placeholder="Your answer"
          ></textarea>
        </div>
      </div>
    </div>
  </div>

  <canvas class="select-none"> </canvas>

  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.3/gsap.min.js"
    integrity="sha512-6zTDRWNxo8vI6JZYDCwhrJpg5icK3P4HNnW3czsO5Scb3lAoPDam+/wF3eog4hxcl0h44d0XlIcFkuoSaWHQ2g=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>
  <!-- <script src="index.js"></script> -->
  <script>
    const canvas = document.querySelector("canvas");
    const c = canvas.getContext("2d");
    canvas.width = innerWidth;
    canvas.height = innerHeight;

    const timeEl = document.querySelector("#timeEl");
    const scoreEl = document.querySelector("#scoreEl");
    const startGameBtn = document.querySelector("#startGameElBtn");
    const modalEl = document.querySelector("#modalEl");
    const bigScoreEl = document.querySelector("#bigScoreEl");
    const exportGameElBtn = document.querySelector("#exportGameElBtn");
    const exportAnswerEl = document.querySelector("#exportAnswerEl");
    const answerFromEl = document.querySelector("#answerFromEl");
    const submitGameElBtn = document.querySelector("#submitGameElBtn");
    const submitFormEl = document.querySelector("#submitFormEl");
    const submitAnswerEl = document.querySelector("#submitAnswerEl");
    const submitBtnEl = document.querySelector("#submitBtnEl");
    class Player {
      constructor(x, y, radius, color) {
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.color = color;
      }

      draw() {
        c.beginPath();
        c.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
        c.fillStyle = this.color;
        c.fill();
      }
    }

    class Projectile {
      constructor(x, y, radius, color, velocity) {
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.color = color;
        this.velocity = velocity;
      }
      draw() {
        c.beginPath();
        c.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
        c.fillStyle = this.color;
        c.fill();
      }

      update() {
        this.draw();
        this.x = this.x + this.velocity.x;
        this.y = this.y + this.velocity.y;
      }
    }

    class Enemy {
      constructor(x, y, radius, color, velocity) {
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.color = color;
        this.velocity = velocity;
      }
      draw() {
        c.beginPath();
        c.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
        c.fillStyle = this.color;
        c.fill();
      }

      update() {
        this.draw();
        this.x = this.x + this.velocity.x;
        this.y = this.y + this.velocity.y;
      }
    }

    const friction = 0.99;

    class Particle {
      constructor(x, y, radius, color, velocity) {
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.color = color;
        this.velocity = velocity;
        this.alpha = 1;
      }
      draw() {
        c.save();
        c.globalAlpha = this.alpha;
        c.beginPath();
        c.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
        c.fillStyle = this.color;
        c.fill();
        c.restore();
      }

      update() {
        this.draw();
        this.velocity.x *= friction;
        this.velocity.y *= friction;
        this.x = this.x + this.velocity.x;
        this.y = this.y + this.velocity.y;
        this.alpha -= 0.01;
      }
    }

    class Ans {
      constructor(time, x, y) {
        this.time = time;
        this.x = x;
        this.y = y;
      }
    }

    const x = canvas.width / 2;
    const y = canvas.height / 2;

    let player = new Player(x, y, 10, "white");
    let projectiles = [];
    let enemies = [];
    let particles = [];
    let answer = [];
    let gameState = false;
    let time = new Date();

    function init() {
      gameState = true;
      time = new Date();
      player = new Player(x, y, 10, "white");
      projectiles = [];
      enemies = [];
      particles = [];
      answer = [];
      score = 0;
      scoreEl.innerHTML = score;
      bigScoreEl.innerHTML = score;
    }

    function spawnEnemies() {
      setInterval(() => {
        const radius = Math.random() * (30 - 4) + 4;
        let x, y;
        if (Math.random() < 0.5) {
          x = Math.random() < 0.5 ? 0 - radius : canvas.width + radius;
          y = canvas.height * Math.random();
        } else {
          x = canvas.width * Math.random();
          y = Math.random() < 0.5 ? 0 - radius : canvas.height + radius;
        }
        const color = `hsl(${Math.random() * 360},50%,50%)`;
        const angle = Math.atan2(canvas.height / 2 - y, canvas.width / 2 - x);
        const velocity = { x: Math.cos(angle), y: Math.sin(angle) };
        enemies.push(new Enemy(x, y, radius, color, velocity));
      }, 1000);
    }

    let animationId;
    let score = 0;
    function animate() {
      animationId = requestAnimationFrame(animate);
      c.fillStyle = "rgba(0,0,0,0.1)";
      c.fillRect(0, 0, canvas.width, canvas.height);
      player.draw();
      particles.forEach((particle, particleIndex) => {
        if (particle.alpha <= 0) {
          particles.splice(particleIndex, 1);
        } else {
          particle.update();
        }
      });
      projectiles.forEach((projectile, projectileIndex) => {
        projectile.update();
        if (
          projectile.x - projectile.radius < 0 ||
          projectile.x - projectile.radius > canvas.width ||
          projectile.y + projectile.radius < 0 ||
          projectile.y - projectile.radius > canvas.height
        ) {
          setTimeout(() => {
            projectiles.splice(projectileIndex, 1);
          }, 0);
        }
      });

      enemies.forEach((enemy, enemyIndex) => {
        enemy.update();
        const dist = Math.hypot(player.x - enemy.x, player.y - enemy.y);
        if (dist - enemy.radius - player.radius < 1) {
          cancelAnimationFrame(animationId);
          modalEl.style.display = "flex";
          bigScoreEl.innerHTML = score;
          gameState = false;
          console.log(answer);
        }
        projectiles.forEach((projectile, projectileIndex) => {
          const dist = Math.hypot(
            projectile.x - enemy.x,
            projectile.y - enemy.y
          );
          if (dist - enemy.radius - projectile.radius < 1) {
            for (let i = 0; i < enemy.radius * 2; ++i) {
              particles.push(
                new Particle(projectile.x, projectile.y, 3, enemy.color, {
                  x: (Math.random() - 0.5) * (Math.random() * 5),
                  y: (Math.random() - 0.5) * (Math.random() * 5),
                })
              );
            }
            if (enemy.radius - 10 > 10) {
              score += 100;
              scoreEl.innerHTML = score;
              gsap.to(enemy, { radius: enemy.radius - 10 });
              setTimeout(() => {
                projectiles.splice(projectileIndex, 1);
              }, 0);
            } else {
              score += 250;
              scoreEl.innerHTML = score;
              setTimeout(() => {
                enemies.splice(enemyIndex, 1);
                projectiles.splice(projectileIndex, 1);
              }, 0);
            }
          }
        });
      });
      timeEl.innerHTML = (new Date() - time) / 1000;
    }

    addEventListener("click", (event) => {
      const angle = Math.atan2(
        event.offsetY - canvas.height / 2,
        event.offsetX - canvas.width / 2
      );
      const velocity = { x: Math.cos(angle) * 5, y: Math.sin(angle) * 5 };
      var time1 = new Date();
      if (gameState === true)
        answer.push(
          JSON.stringify(new Ans((time1 - time) / 1000, velocity.x, velocity.y))
        );
      projectiles.push(
        new Projectile(
          canvas.width / 2,
          canvas.height / 2,
          5,
          "white",
          velocity
        )
      );
    });

    startGameBtn.addEventListener("click", () => {
      init();
      animate(), spawnEnemies();
      modalEl.style.display = "none";
      exportAnswerEl.style.display = "none";
    });
    exportGameElBtn.addEventListener("click", () => {
      answerFromEl.value = answer;
      if (exportAnswerEl.style.display == "flex")
        exportAnswerEl.style.display = "none";
      else exportAnswerEl.style.display = "flex";
    });
    submitGameElBtn.addEventListener("click", () => {
      submitFormEl.value = "";
      if (submitAnswerEl.style.display == "flex") {
        submitAnswerEl.style.display = "none";
        submitBtnEl.style.display = "none";
      } else {
        submitAnswerEl.style.display = "flex";
        submitBtnEl.style.display = "inline-block";
      }
    });
    submitBtnEl.addEventListener("click", () => {
      init();
      animate(), spawnEnemies();
      modalEl.style.display = "none";
      exportAnswerEl.style.display = "none";
    });
  </script>
</div>
